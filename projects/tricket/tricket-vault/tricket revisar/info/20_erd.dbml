// Tricket ERD (DBML) — Fonte para geração de diagrama
// Origem: tricket-backend/supabase/migrations/
// Observação: este arquivo é um scaffold inicial. A próxima etapa é autogerar as entidades e FKs a partir das migrações.

Project tricket {
  database_type: "PostgreSQL"
  note: "ERD gerado a partir das migrações do Supabase."
}

// ===== Domínio: RBAC =====
Table public.rbac_roles {
  id uuid [pk, default: `extensions.uuid_generate_v4()`]
  name text [not null, unique]
  description text
  level int
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  Note: 'Funções globais de RBAC'
}

Table public.rbac_user_roles {
  id uuid [pk, default: `extensions.uuid_generate_v4()`]
  user_id uuid [not null]
  role_id uuid [not null]
  created_at timestamptz [default: `now()`]
  indexes {
    (user_id, role_id) [unique]
  }
  Note: 'Associação de usuários a funções'
}

// ===== Domínio: UI =====
Table public.ui_app_settings {
  key text [pk]
  value text
  description text
  Note: 'Configurações chave-valor'
}

Table public.ui_app_pages {
  id text [pk]
  path text [not null, unique]
  name text [not null]
  description text
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  Note: 'Páginas da aplicação'
}

Table public.ui_app_elements {
  id text [pk]
  element_type public.element_type_enum [not null]
  parent_id text
  page_id text
  label text [not null]
  icon text
  path text
  position smallint [default: 0]
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  Note: 'Elementos de navegação'
}

Table public.ui_role_element_permissions {
  role_id uuid [not null]
  element_id text [not null]
  indexes { (role_id, element_id) [pk] }
  Note: 'Permissões de elementos por role'
}

Table public.ui_grids {
  id text [pk]
  page_id text
  collection_id uuid
  description text
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  Note: 'Configuração de grids'
}

Table public.ui_grid_columns {
  id uuid [pk, default: `gen_random_uuid()`]
  grid_id text [not null]
  data_key text [not null]
  label text [not null]
  size text [default: '1fr']
  position int [default: 0]
  is_visible boolean [default: true]
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  indexes { (grid_id, data_key) [unique] }
  Note: 'Colunas das grids'
}

Table public.ui_app_collors {
  id uuid [pk, default: `gen_random_uuid()`]
  name text [not null, unique]
  light_theme_hex text [not null]
  dark_theme_hex text [not null]
  category text [not null]
  description text
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  Note: 'Paleta de cores'
}

// ===== Domínio: CMS =====
Table public.cms_categories {
  id uuid [pk, default: `uuid_generate_v4()`]
  name text [not null, unique]
  slug text [not null, unique]
  description text
}

Table public.cms_tags {
  id uuid [pk, default: `uuid_generate_v4()`]
  name text [not null, unique]
  slug text [not null, unique]
}

Table public.cms_posts {
  id uuid [pk, default: `uuid_generate_v4()`]
  type public.cms_post_type [not null]
  category_id uuid
  slug text [not null, unique]
  title text [not null]
  excerpt text
  cover_image_url text
  author_id uuid
  status public.cms_post_status [not null, default: 'DRAFT']
  published_at timestamptz
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
}

Table public.cms_post_tags {
  post_id uuid [not null]
  tag_id uuid [not null]
  indexes { (post_id, tag_id) [pk] }
}

Table public.cms_post_versions {
  id uuid [pk, default: `uuid_generate_v4()`]
  post_id uuid [not null]
  version int [not null]
  content jsonb [not null]
  change_log text
  author_id uuid
  created_at timestamptz [default: `now()`]
  indexes { (post_id, version) [unique] }
}

Table public.cms_post_user_agreements {
  id uuid [pk, default: `uuid_generate_v4()`]
  profile_id uuid [not null]
  post_version_id uuid [not null]
  agreed_at timestamptz [default: `now()`]
  ip_address inet
  indexes { (profile_id, post_version_id) [unique] }
}

Table public.cms_comments {
  id uuid [pk, default: `uuid_generate_v4()`]
  post_id uuid [not null]
  author_id uuid [not null]
  parent_comment_id uuid
  content text [not null]
  created_at timestamptz [default: `now()`]
  updated_at timestamptz
}

// ===== Domínio: IAM =====
Table public.iam_profiles {
  id uuid [pk, default: `extensions.uuid_generate_v4()`]
  profile_type public.profile_type_enum [not null]
  avatar_url text
  onboarding_status public.onboarding_status_enum [not null]
  time_zone text [default: 'America/Sao_Paulo']
  active boolean [default: true]
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  Note: 'Tabela principal de perfis'
}

Table public.iam_individual_details {
  profile_id uuid [pk, not null]
  auth_user_id uuid [not null, unique]
  profile_role public.individual_profile_role_enum [not null]
  full_name text [not null]
  cpf text [not null, unique]
  birth_date date [not null]
  gender text
  income_value_cents bigint
  contact_email text
  contact_phone text
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  Note: 'Detalhes de pessoa física'
}

Table public.iam_organization_details {
  profile_id uuid [pk, not null]
  platform_role public.organization_platform_role_enum [not null]
  company_name text [not null]
  trade_name text
  cnpj text [not null, unique]
  company_type public.company_type_enum [not null]
  income_value_cents bigint
  contact_email text [unique]
  contact_phone text
  national_registry_for_legal_entities_status text
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  Note: 'Detalhes de pessoa jurídica'
}

Table public.iam_organization_members {
  organization_profile_id uuid [not null]
  member_user_id uuid [not null]
  role public.organization_member_role_enum [not null]
  is_active boolean [default: true]
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  indexes {
    (organization_profile_id, member_user_id) [pk]
  }
  Note: 'Membros de organizações'
}

Table public.iam_profile_invitations {
  id uuid [pk, default: `extensions.uuid_generate_v4()`]
  email text [not null]
  name text
  invited_as_profile_type public.profile_type_enum [not null]
  role public.organization_member_role_enum
  invited_by_user_id uuid
  org_id uuid
  token text [not null, unique]
  expires_at timestamptz [not null]
  status public.invitation_status_enum [not null, default: 'PENDING']
  accepted_at timestamptz
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  Note: 'Convites para perfis/organizações'
}

Table public.iam_addresses {
  id uuid [pk, default: `gen_random_uuid()`]
  profile_id uuid [not null]
  address_type public.address_type_enum [not null]
  is_default boolean [default: false]
  street text [not null]
  number text [not null]
  complement text
  neighborhood text [not null]
  city_id int [not null]
  state_id int [not null]
  zip_code text [not null]
  country text [not null, default: 'Brasil']
  latitude numeric(10,7)
  longitude numeric(10,7)
  geolocation geography
  notes text
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  Note: 'Endereços de perfis'
}

Table public.iam_contacts {
  id uuid [pk, default: `gen_random_uuid()`]
  profile_id uuid [not null]
  name text
  label text
  email text
  phone text
  whatsapp boolean [default: false]
  is_default boolean [default: false]
  email_verified boolean [default: false]
  phone_verified boolean [default: false]
  verified_at timestamptz
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  Note: 'Contatos de perfis'
}

Table public.iam_profile_uploaded_documents {
  id uuid [pk, default: `gen_random_uuid()`]
  profile_id uuid [not null]
  document_name text [not null]
  status text [not null]
  file_path text [not null]
  storage_bucket text [not null]
  verified_by_user_id uuid
  verification_date timestamptz
  rejection_reason_id uuid
  rejection_notes text
  expires_at timestamptz
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  Note: 'Documentos enviados por perfis'
}

Table public.iam_rejection_reasons {
  id uuid [pk, default: `gen_random_uuid()`]
  reason_code varchar(100) [not null, unique]
  description text [not null]
  category public.rejection_reason_category_enum [not null]
  source_system text
  user_action_required text
  internal_notes text
  is_active boolean [default: true]
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  Note: 'Catálogo de motivos de rejeição'
}

Table public.iam_profile_rejections {
  id uuid [pk, default: `gen_random_uuid()`]
  profile_id uuid [not null]
  rejection_reason_id uuid [not null]
  related_entity_id uuid
  related_entity_type text
  rejected_by_user_id uuid
  rejected_at timestamptz [default: `now()`]
  notes text
  is_resolved boolean [default: false]
  resolved_at timestamptz
  resolution_notes text
  resolved_by_user_id uuid
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  Note: 'Histórico de rejeições de perfis'
}

Table public.iam_user_preferences {
  user_id uuid [pk]
  active_profile_id uuid
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  Note: 'Preferências do usuário (perfil ativo)'
}

// ===== Domínio: Marketplace =====
Table public.marketplace_departments {
  id uuid [pk, default: `gen_random_uuid()`]
  name text [not null, unique]
  slug text [not null, unique]
  description text
  icon_url text
  is_active boolean [default: true]
  sort_order int [default: 0]
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
}

Table public.marketplace_categories {
  id uuid [pk, default: `gen_random_uuid()`]
  department_id uuid [not null]
  name text [not null]
  slug text [not null]
  description text
  icon_url text
  is_active boolean [default: true]
  sort_order int [default: 0]
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  indexes { (department_id, name) [unique], (department_id, slug) [unique] }
}

Table public.marketplace_sub_categories {
  id uuid [pk, default: `gen_random_uuid()`]
  category_id uuid [not null]
  name text [not null]
  slug text [not null]
  description text
  icon_url text
  is_active boolean [default: true]
  sort_order int [default: 0]
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  indexes { (category_id, name) [unique], (category_id, slug) [unique] }
}

Table public.marketplace_brands {
  id uuid [pk, default: `gen_random_uuid()`]
  name text [not null, unique]
  slug text [unique]
  description text
  logo_url text
  official_website text
  country_of_origin_code text
  gs1_company_prefix text
  gln_brand_owner text
  status text [default: 'PENDING_APPROVAL']
  approved_by_user_id uuid
  approved_at timestamptz
  created_by_user_id uuid
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
}

Table public.marketplace_products {
  id uuid [pk, default: `gen_random_uuid()`]
  sub_category_id uuid
  brand_id uuid
  name text [not null]
  description text
  sku_base text
  attributes jsonb
  status text [default: 'ACTIVE']
  gtin text [not null, unique]
  gpc_category_code text
  ncm_code text
  cest_code text
  net_content numeric
  net_content_unit text
  gross_weight numeric
  net_weight numeric
  weight_unit text
  height numeric
  width numeric
  depth numeric
  dimension_unit text
  country_of_origin_code text
  gs1_company_name text
  gs1_company_gln text
  created_by_user_id uuid
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
}

Table public.marketplace_product_images {
  id uuid [pk, default: `gen_random_uuid()`]
  product_id uuid [not null]
  image_url text [not null]
  alt_text text
  sort_order int [default: 0]
  image_type_code text
  created_at timestamptz [default: `now()`]
}

Table public.marketplace_supplier_products {
  id uuid [pk, default: `gen_random_uuid()`]
  product_id uuid [not null]
  supplier_profile_id uuid [not null]
  supplier_sku text
  price_cents int [not null]
  cost_price_cents int
  promotional_price_cents int
  promotion_start_date timestamptz
  promotion_end_date timestamptz
  min_order_quantity int [default: 1]
  max_order_quantity int
  barcode_ean text
  status text [default: 'DRAFT']
  is_active_by_supplier boolean [default: true]
  approved_at timestamptz
  created_by_user_id uuid
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
  indexes { (product_id, supplier_profile_id) [unique] }
}

Table public.marketplace_gpc_to_tricket_category_mapping {
  gpc_category_code text [pk]
  gpc_category_name text
  tricket_sub_category_id uuid
  status text [not null, default: 'PENDENT']
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
}

// ===== Domínio: Asaas =====
Table public.asaas_accounts {
  id uuid [pk, default: `extensions.uuid_generate_v4()`]
  profile_id uuid [not null]
  asaas_account_id text [not null, unique]
  api_key text [not null]
  account_status text [default: 'PENDING']
  account_type text [default: 'MERCHANT']
  wallet_id text
  webhook_url text
  webhook_token text
  onboarding_status text [default: 'PENDING']
  verification_status text
  onboarding_data jsonb
  account_settings jsonb
  fees_configuration jsonb
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
}

Table public.asaas_customers {
  id uuid [pk, default: `extensions.uuid_generate_v4()`]
  asaas_account_id uuid [not null]
  profile_id uuid
  asaas_customer_id text [not null, unique]
  customer_name text [not null]
  customer_email text
  customer_phone text
  customer_cpf_cnpj text
  customer_type text
  address jsonb
  customer_data jsonb
  is_active boolean [default: true]
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
}

Table public.asaas_payments {
  id uuid [pk, default: `extensions.uuid_generate_v4()`]
  asaas_account_id uuid [not null]
  asaas_customer_id uuid [not null]
  marketplace_payment_id uuid
  asaas_payment_id text [not null, unique]
  billing_type text [not null]
  payment_status text [default: 'PENDING']
  value_cents int [not null]
  net_value_cents int
  original_value_cents int
  interest_value_cents int
  description text
  external_reference text
  due_date date [not null]
  payment_date date
  credit_date date
  estimated_credit_date date
  installment_count int [default: 1]
  installment_number int [default: 1]
  installment_value_cents int
  discount jsonb
  fine jsonb
  interest jsonb
  payment_link text
  bank_slip_url text
  invoice_url text
  pix_transaction jsonb
  credit_card jsonb
  asaas_response jsonb
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
}

Table public.asaas_webhooks {
  id uuid [pk, default: `extensions.uuid_generate_v4()`]
  asaas_account_id uuid
  webhook_event text [not null]
  webhook_data jsonb [not null]
  processed boolean [default: false]
  processed_at timestamptz
  processing_error text
  retry_count int [default: 0]
  signature_valid boolean
  raw_payload text
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
}

// ===== Domínio: Cappta =====
Table public.cappta_accounts {
  id uuid [pk, default: `extensions.uuid_generate_v4()`]
  profile_id uuid [not null]
  cappta_account_id text [not null, unique]
  account_status text [default: 'PENDING']
  account_type text
  merchant_id text
  terminal_id text
  api_key text
  secret_key text
  webhook_url text
  webhook_secret text
  onboarding_status text [default: 'PENDING']
  onboarding_data jsonb
  verification_documents jsonb
  account_settings jsonb
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
}

Table public.cappta_transactions {
  id uuid [pk, default: `extensions.uuid_generate_v4()`]
  cappta_account_id uuid [not null]
  marketplace_payment_id uuid
  cappta_transaction_id text [not null, unique]
  transaction_type text [not null]
  transaction_status text [default: 'PENDING']
  amount_cents int [not null]
  currency_code text [default: 'BRL']
  payment_method text
  card_brand text
  card_last_digits text
  authorization_code text
  nsu text
  tid text
  installments int [default: 1]
  merchant_fee_cents int
  gateway_fee_cents int
  net_amount_cents int
  settlement_date date
  transaction_data jsonb
  cappta_response jsonb
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
}

Table public.cappta_webhooks {
  id uuid [pk, default: `extensions.uuid_generate_v4()`]
  cappta_account_id uuid
  webhook_event text [not null]
  webhook_data jsonb [not null]
  processed boolean [default: false]
  processed_at timestamptz
  processing_error text
  retry_count int [default: 0]
  signature_valid boolean
  raw_payload text
  created_at timestamptz [default: `now()`]
  updated_at timestamptz [default: `now()`]
}

Table public.cappta_api_responses {
  id uuid [pk, default: `extensions.uuid_generate_v4()`]
  cappta_account_id uuid
  endpoint text [not null]
  http_method text [not null]
  request_data jsonb
  response_status int
  response_data jsonb
  response_time_ms int
  error_message text
  created_at timestamptz [default: `now()`]
}

// Catálogos Cappta (listados nas migrações):
Table public.cappta_mcc_options { id int [pk] code text description text }
Table public.cappta_legal_nature_options { id int [pk] code text description text }
Table public.cappta_status_options { id int [pk] code text description text }
Table public.cappta_account_type_options { id int [pk] code text description text }
Table public.cappta_plan_types { id int [pk] code text description text }
Table public.cappta_product_types { id int [pk] code text description text }

// ===== Domínio: GS1 =====
// Table public.gs1_api_responses

// ===== Views =====
// Ref view_* serão documentadas no dicionário; opcional incluir como entidades lógicas no diagrama final

// ===== Refs (FKs extraídas das migrações) =====
// RBAC
Ref: public.rbac_user_roles.user_id > auth.users.id
Ref: public.rbac_user_roles.role_id > public.rbac_roles.id

// UI
Ref: public.ui_app_elements.parent_id > public.ui_app_elements.id
Ref: public.ui_app_elements.page_id > public.ui_app_pages.id
Ref: public.ui_role_element_permissions.role_id > public.rbac_roles.id
Ref: public.ui_role_element_permissions.element_id > public.ui_app_elements.id
Ref: public.ui_grids.page_id > public.ui_app_pages.id
Ref: public.ui_grid_columns.grid_id > public.ui_grids.id

// CMS
Ref: public.cms_posts.category_id > public.cms_categories.id
Ref: public.cms_posts.author_id > auth.users.id
Ref: public.cms_post_tags.post_id > public.cms_posts.id
Ref: public.cms_post_tags.tag_id > public.cms_tags.id
Ref: public.cms_post_versions.post_id > public.cms_posts.id
Ref: public.cms_post_versions.author_id > auth.users.id
Ref: public.cms_post_user_agreements.post_version_id > public.cms_post_versions.id
Ref: public.cms_comments.post_id > public.cms_posts.id
Ref: public.cms_comments.author_id > auth.users.id
Ref: public.cms_comments.parent_comment_id > public.cms_comments.id

// IAM
Ref: public.iam_individual_details.profile_id > public.iam_profiles.id
Ref: public.iam_individual_details.auth_user_id > auth.users.id
Ref: public.iam_organization_details.profile_id > public.iam_profiles.id
Ref: public.iam_organization_members.organization_profile_id > public.iam_profiles.id
Ref: public.iam_organization_members.member_user_id > auth.users.id
Ref: public.iam_profile_invitations.invited_by_user_id > auth.users.id
Ref: public.iam_profile_invitations.org_id > public.iam_profiles.id
Ref: public.iam_addresses.profile_id > public.iam_profiles.id
Ref: public.iam_addresses.city_id > public.generic_cities.id
Ref: public.iam_addresses.state_id > public.generic_states.id
Ref: public.iam_contacts.profile_id > public.iam_profiles.id
Ref: public.iam_profile_uploaded_documents.profile_id > public.iam_profiles.id
Ref: public.iam_profile_uploaded_documents.verified_by_user_id > auth.users.id
Ref: public.iam_profile_uploaded_documents.rejection_reason_id > public.iam_rejection_reasons.id
Ref: public.iam_profile_rejections.profile_id > public.iam_profiles.id
Ref: public.iam_profile_rejections.rejection_reason_id > public.iam_rejection_reasons.id
Ref: public.iam_profile_rejections.rejected_by_user_id > auth.users.id
Ref: public.iam_profile_rejections.resolved_by_user_id > auth.users.id
Ref: public.iam_user_preferences.user_id > auth.users.id
Ref: public.iam_user_preferences.active_profile_id > public.iam_profiles.id

// Marketplace
Ref: public.marketplace_categories.department_id > public.marketplace_departments.id
Ref: public.marketplace_sub_categories.category_id > public.marketplace_categories.id
Ref: public.marketplace_products.sub_category_id > public.marketplace_sub_categories.id
Ref: public.marketplace_products.brand_id > public.marketplace_brands.id
Ref: public.marketplace_products.created_by_user_id > auth.users.id
Ref: public.marketplace_product_images.product_id > public.marketplace_products.id
Ref: public.marketplace_supplier_products.product_id > public.marketplace_products.id
Ref: public.marketplace_supplier_products.supplier_profile_id > public.iam_profiles.id
Ref: public.marketplace_supplier_products.created_by_user_id > auth.users.id
Ref: public.marketplace_gpc_to_tricket_category_mapping.tricket_sub_category_id > public.marketplace_sub_categories.id

// Asaas
Ref: public.asaas_accounts.profile_id > public.iam_profiles.id
Ref: public.asaas_customers.asaas_account_id > public.asaas_accounts.id
Ref: public.asaas_customers.profile_id > public.iam_profiles.id
Ref: public.asaas_payments.asaas_account_id > public.asaas_accounts.id
Ref: public.asaas_payments.asaas_customer_id > public.asaas_customers.id
Ref: public.asaas_webhooks.asaas_account_id > public.asaas_accounts.id

// Cappta
Ref: public.cappta_accounts.profile_id > public.iam_profiles.id
Ref: public.cappta_transactions.cappta_account_id > public.cappta_accounts.id
Ref: public.cappta_webhooks.cappta_account_id > public.cappta_accounts.id
Ref: public.cappta_api_responses.cappta_account_id > public.cappta_accounts.id

// GS1 (nenhuma FK explícita nas migrações vistas)

// Próximos passos:
// 1) Autogerar tabelas com colunas/PK/FK/índices a partir de DDLs
// 2) Renderizar ERD (dbml-renderer / Mermaid / PlantUML)

// Planejados (sem tabela):
// - asaas_payments.marketplace_payment_id -> marketplace_payments.id (planejado; tabela não existe)
// - cappta_transactions.marketplace_payment_id -> marketplace_payments.id (planejado; tabela não existe)
