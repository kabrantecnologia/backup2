# Changelog Consolidado ‚Äî 2025-08-10 a 2025-08-11

Este documento consolida os seguintes arquivos do diret√≥rio `tricket-vault/changelog/`:

- 2025-08-11-1126-atualizacoes_sistema_testes.md
- 2025-08-11-1117-rpc_and_marketplace_inserts.md
- 2025-08-11-1038-atualizacao_documentacao_arquitetura.md
- 2025-08-10-1521-refatoracao-testes-tricket.md

---

## 2025-08-11T11:26:01-03:00 ‚Äî Changelog ‚Äî Sistema de Testes Tricket

Data/Hora: 2025-08-11T11:26:01-03:00

### Contexto
Alinhamento do sistema de testes em `tricket-backend/testing-tricket/` com as funcionalidades presentes no c√≥digo, inclus√£o de opera√ß√£o de aprova√ß√£o de profiles (Admin) e corre√ß√µes no README.

### Altera√ß√µes Principais
- Atualiza√ß√£o do `README.md` para refletir fielmente o menu de opera√ß√µes do `main.py`.
- Inclus√£o da opera√ß√£o interativa de aprova√ß√£o: "Aprovar Profile (Admin)" no menu do sistema de testes.
- Cria√ß√£o de helper robusto para aprova√ß√£o (`_approve_profile_by_id`) com fallback de RPCs: `rpc_approve_user_profile` e `approve_user_profile`.
- Padroniza√ß√£o do script `approve_specific_profile.py` para remover ID hardcoded e aceitar ID via CLI ou modo interativo.
- Corre√ß√£o dos perfis de exemplo no README para: `admin`, `fornecedor`, `comerciante`, `consumidor`.
- Inclus√£o de instru√ß√µes r√°pidas de instala√ß√£o (venv + requirements) e remo√ß√£o de depend√™ncia de √≠ndices num√©ricos do menu.

### Arquivos Modificados
- `tricket-backend/testing-tricket/README.md`
- `tricket-backend/testing-tricket/main.py`
- `tricket-backend/testing-tricket/operations/profile_approval.py`
- `tricket-backend/testing-tricket/approve_specific_profile.py`

### Detalhes T√©cnicos
- `main.py`: adicionado import e mapeamento da opera√ß√£o "Aprovar Profile (Admin)" para `approve_user_profile_interactive`.
- `operations/profile_approval.py`:
  - Novo helper `_approve_profile_by_id(project_name, profile_id)` com autentica√ß√£o do admin e tentativa sequencial das RPCs.
  - Nova fun√ß√£o `approve_user_profile_interactive(project_name)` que solicita o ID do profile.
  - `approve_user_profile` agora delega ao helper interno.
- `approve_specific_profile.py`:
  - Suporte a `profile_id` via argumento de linha de comando.
  - Caso n√£o informado, ativa fluxo interativo reutilizando `approve_user_profile_interactive`.

### Instru√ß√µes de Uso
1. Opcional: criar e ativar venv, instalar depend√™ncias em `tricket-backend/testing-tricket/`:
   ```bash
   python -m venv .venv && source .venv/bin/activate
   pip install -r requirements.txt
   ```
2. Executar o sistema de testes:
   ```bash
   python main.py
   ```
3. Para aprovar profiles:
   - Fa√ßa login como `admin@tricket.com.br` (opera√ß√£o "Login de Usu√°rio").
   - Liste profiles pendentes ("Ver Profiles para Aprova√ß√£o (Admin)").
   - Aprove com:
     - Pelo menu: "Aprovar Profile (Admin)" (insira o ID solicitado);
     - Ou via script:
       ```bash
       python approve_specific_profile.py <PROFILE_ID>
       # ou sem argumento para modo interativo
       python approve_specific_profile.py
       ```

### Impacto
- Documenta√ß√£o do sistema de testes coerente com o c√≥digo atual.
- Fluxo de aprova√ß√£o de profiles dispon√≠vel via menu e script, reduzindo erros por nomes de RPC divergentes.
- Melhoria na DX com exemplos atualizados e instala√ß√£o orientada.

---

## 2025-08-11T11:17:28-03:00 ‚Äî RPC debug + Padr√£o RPC + Inserts Marketplace

### Resumo
- __[Novo]__ Fun√ß√£o de diagn√≥stico `public.rpc_debug_request` para inspecionar como a requisi√ß√£o chega via Supabase (headers, claims, auth.uid, payload).
- __[Novo]__ Documento de padr√£o para desenvolvimento de RPCs.
- __[Novo]__ RPCs de cria√ß√£o (admin-only) para hierarquia do marketplace e cat√°logo base.

### Itens criados/alterados
- Arquivo: `tricket-backend/supabase/migrations/605_rpc_debug_request.sql`
  - Fun√ß√£o: `public.rpc_debug_request(p_payload jsonb default '{}'::jsonb)`
  - Retorna: `JSONB` com `auth_uid`, `db_role`, `jwt_claims`, `headers`, `headers_summary`, `received_arguments`.
  - Seguran√ßa: `SECURITY DEFINER`, `SET search_path = ''`, `GRANT EXECUTE TO authenticated`.

- Arquivo: `tricket-vault/resources/rpc-functions-standard.md`
  - Guia oficial de padr√µes para cria√ß√£o de RPCs: seguran√ßa, naming, par√¢metros, retornos, RBAC, exemplos (WeWeb, supabase-js, cURL), anti‚Äëpadr√µes e checklist.

- Arquivo: `tricket-backend/supabase/migrations/610_rpc_marketplace_insert.sql`
  - Helpers:
    - `public.slugify(text)`
    - `public._ensure_admin()` ‚Äî valida ADMIN via `rbac_user_roles` + `rbac_roles`.
  - RPCs (ADMIN only):
    - `public.rpc_create_marketplace_department(p_data jsonb)`
    - `public.rpc_create_marketplace_category(p_data jsonb)`
    - `public.rpc_create_marketplace_sub_category(p_data jsonb)`
    - `public.rpc_create_marketplace_brand(p_data jsonb)`
    - `public.rpc_create_marketplace_product(p_data jsonb)`
  - Padr√µes: `SECURITY DEFINER`, `SET search_path = ''`, objetos qualificados, `GRANT EXECUTE TO authenticated`, retorno do registro inserido como `JSONB`, captura de `unique_violation`.

### Como chamar (WeWeb)
- N√≥: Call a Postgres function
- Exemplo (create product): Function name `rpc_create_marketplace_product`
- Arguments:
```json
{
  "p_data": {
    "name": "Arroz Tipo 1 1kg",
    "gtin": "07894900086003",
    "brand_id": "<uuid>",
    "sub_category_id": "<uuid>",
    "attributes": { "tipo": "agulhinha" }
  }
}
```

### Observa√ß√µes de Seguran√ßa
- Apesar do `GRANT` para `authenticated`, as RPCs de inser√ß√£o executam `public._ensure_admin()` e falham para n√£o-admins.
- `rpc_debug_request` n√£o altera estado; retorno inclui headers e claims para documenta√ß√£o e troubleshooting.

### Motiva√ß√£o
- Documentar e padronizar o consumo de RPCs pelo front-end WeWeb.
- Fornecer endpoints administr√°veis para popular a hierarquia do marketplace e cat√°logo.

### Impacto
- Front-end pode diagnosticar chamadas via `rpc_debug_request`.
- Admin pode cadastrar departamentos/categorias/subcategorias/marcas/produtos via RPC segura e padronizada.

### Pr√≥ximos Passos Sugeridos
- Adicionar RPCs de atualiza√ß√£o/remo√ß√£o com as mesmas diretrizes.
- Testes automatizados SQL para valida√ß√£o de entradas e cen√°rios de erro.
- Ajustar pol√≠ticas RLS conforme necessidade.

---

## 2025-08-11 ‚Äî Atualiza√ß√£o da Documenta√ß√£o de Arquitetura e Dicion√°rio de Dados

Data: 2025-08-11  
Respons√°vel: Cascade (Assistente)

### Escopo
- Documentos afetados:
  - `tricket-vault/resources/110-supabase_arquitetura.md`
  - `tricket-vault/resources/120_dicionario_de_dados.md`
- Fonte de verdade analisada:
  - `tricket-backend/supabase/migrations/`

### Resumo das Altera√ß√µes
- Arquitetura (`110-supabase_arquitetura.md`)
  - Ajuste dos nomes de arquivos de migra√ß√£o para o padr√£o atual (ex.: `100_global_settings.sql`, `120_rbac.sql`, `200_iam_tables.sql`, `140_ui_structure.sql`, etc.).
  - Inclus√£o das novas entidades do m√≥dulo ‚ÄúAsaas Master Webhook‚Äù de `231_asaas_master_webhook.sql`:
    - Tabelas: `public.master_webhook_events`, `public.master_financial_transactions`, `public.subscription_propagation_log`.
    - View: `public.v_master_webhook_summary`.
    - Triggers: `update_master_webhook_events_updated_at`, `update_master_financial_transactions_updated_at`, `update_subscription_propagation_log_updated_at`.
  - Corre√ß√£o e reorganiza√ß√£o da se√ß√£o de Views para refletir os arquivos: `300_views_global.sql`, `310_views_admin.sql`, `320_views_asaas.sql`, `330_cms_views.sql`.
  - Atualiza√ß√£o do mapeamento de Fun√ß√µes para os arquivos corretos:
    - Core/Util: `100_global_settings.sql`, `530_functions_calculate_geolocation.sql`.
    - Checks: `500_functions_check.sql`.
    - Contexto: `510_functions_user_contexts.sql`.
    - IAM: `560_iam_functions.sql`.
    - Termos: `520_functions_terms.sql`.
    - Registro de perfis: `550_functions_register_profiles.sql`.
    - Marketplace/Produtos: `540_functions_check_product_exists.sql`.
    - Asaas: `570_functions_asaas.sql`.
    - Cappta: `580_functions_cappta.sql`.
    - Asaas Master: `231_asaas_master_webhook.sql` (fun√ß√£o `update_updated_at_column`).
  - Atualiza√ß√£o das refer√™ncias de √≠ndices e FKs conforme migra√ß√µes vigentes, incluindo √≠ndices de Asaas Master.
  - Ajuste das fontes dos GRANTs para as novas migra√ß√µes de fun√ß√µes.

- Dicion√°rio de Dados (`120_dicionario_de_dados.md`)
  - Completa√ß√£o da tabela `public.gs1_api_responses` a partir de `220_gs1_tables.sql` com colunas, constraints e coment√°rios.
  - Inclus√£o da view `v_master_webhook_summary` na listagem de views.

### Itens N√£o Modificados
- Sem altera√ß√µes nos arquivos SQL de migra√ß√£o; somente documenta√ß√£o atualizada.

### Observa√ß√µes / Pontos de Aten√ß√£o
- RLS/Policies: manter rastreamento cont√≠nuo; apenas exemplos presentes foram listados. Uma varredura adicional pode ser necess√°ria ao evoluir o esquema.
- Algumas se√ß√µes do dicion√°rio ainda t√™m [TODO] (ex.: op√ß√µes Cappta) e podem ser preenchidas em itera√ß√µes seguintes.

### Refer√™ncias
- `tricket-backend/supabase/migrations/100_global_settings.sql`
- `tricket-backend/supabase/migrations/120_rbac.sql`
- `tricket-backend/supabase/migrations/130_cms_blog_structure.sql`
- `tricket-backend/supabase/migrations/140_ui_structure.sql`
- `tricket-backend/supabase/migrations/200_iam_tables.sql`
- `tricket-backend/supabase/migrations/210_marketplace_tables.sql`
- `tricket-backend/supabase/migrations/220_gs1_tables.sql`
- `tricket-backend/supabase/migrations/231_asaas_master_webhook.sql`
- `tricket-backend/supabase/migrations/300_views_global.sql`
- `tricket-backend/supabase/migrations/310_views_admin.sql`
- `tricket-backend/supabase/migrations/320_views_asaas.sql`
- `tricket-backend/supabase/migrations/330_cms_views.sql`
- `tricket-backend/supabase/migrations/500_functions_check.sql`
- `tricket-backend/supabase/migrations/510_functions_user_contexts.sql`
- `tricket-backend/supabase/migrations/520_functions_terms.sql`
- `tricket-backend/supabase/migrations/530_functions_calculate_geolocation.sql`
- `tricket-backend/supabase/migrations/540_functions_check_product_exists.sql`
- `tricket-backend/supabase/migrations/550_functions_register_profiles.sql`
- `tricket-backend/supabase/migrations/560_iam_functions.sql`
- `tricket-backend/supabase/migrations/570_functions_asaas.sql`
- `tricket-backend/supabase/migrations/580_functions_cappta.sql`

---

## 2025-08-10 15:21:33 (UTC-3) ‚Äî üöÄ Refatora√ß√£o Completa - Sistema de Testes Tricket

**Data:** 2025-08-10 15:21:33 (UTC-3)  
**Autor:** SHELDON  
**Branch:** sprint-8  
**Status:** ‚úÖ COMPLETO

### üìã Resumo das Mudan√ßas

Sistema de testes automatizados do Tricket backend completamente refatorado com corre√ß√£o de bugs cr√≠ticos e implementa√ß√£o de detec√ß√£o autom√°tica de tipos de perfil.

### üéØ Objetivo Principal

- **Corrigir** erro de atributo `created_at` no objeto Session
- **Implementar** detec√ß√£o autom√°tica entre perfis individuais e organizacionais
- **Garantir** 100% de taxa de sucesso no cadastro em lote

### üîß Arquivos Modificados

#### `operations/auth.py`
- ‚úÖ Corrigido erro `created_at` nas fun√ß√µes `create_user_and_profile()` e `login_user()`
- ‚úÖ Adicionado uso de `datetime.now().isoformat()` para timestamps
- ‚úÖ Implementada detec√ß√£o autom√°tica de tipo de perfil

#### `operations/bulk_operations.py`
- ‚úÖ Corrigido erro `created_at` no armazenamento de tokens
- ‚úÖ Atualizada l√≥gica para usar fun√ß√µes corretas baseadas no tipo de perfil
- ‚úÖ Adicionada vers√£o silenciosa para processamento em lote

#### `operations/individual_profile.py` (NOVO)
- ‚úÖ Criada fun√ß√£o `register_individual_profile_from_config()`
- ‚úÖ Implementada l√≥gica espec√≠fica para perfis individuais (CONSUMER)
- ‚úÖ Interface interativa para sele√ß√£o de perfis

#### `operations/profile_batch.py` (NOVO)
- ‚úÖ Criada vers√£o silenciosa `register_organization_profile_batch()`
- ‚úÖ Otimizada para processamento em lote sem intera√ß√£o
- ‚úÖ Tratamento de erros simplificado para opera√ß√µes automatizadas

#### `operations/token_manager.py` (NOVO)
- ‚úÖ Sistema completo de gerenciamento de tokens
- ‚úÖ Armazenamento local seguro de sess√µes
- ‚úÖ Interface CLI para gerenciar tokens ativos

#### `main.py`
- ‚úÖ Adicionada op√ß√£o "Criar Perfil Individual" no menu principal
- ‚úÖ Integra√ß√£o com todas as novas funcionalidades
- ‚úÖ Menu interativo aprimorado

#### `operations/profile.py`
- ‚úÖ Atualizada `register_organization_profile_from_config()` para aceitar par√¢metro opcional
- ‚úÖ Adicionada l√≥gica para uso direto de `profile_name` em modo batch

#### `README.md` (ATUALIZADO)
- ‚úÖ Documenta√ß√£o completa das novas opera√ß√µes
- ‚úÖ Instru√ß√µes de uso para cada funcionalidade
- ‚úÖ Exemplos de configura√ß√£o

### üß™ Testes Realizados

#### ‚úÖ Cadastro em Lote
```
Total Processado: 4
‚úÖ Sucessos: 4
‚ùå Falhas: 0
üìä Taxa de Sucesso: 100.0%
```

#### ‚úÖ Tipos de Perfil Detectados Automaticamente
- **CONSUMER** ‚Üí `register_individual_profile_from_config()`
- **FORNECEDOR/COMERCIANTE/REVENDEDOR** ‚Üí `register_organization_profile_batch()`

#### ‚úÖ Opera√ß√µes Verificadas
1. **Criar Conta + Perfil Completo** ‚úÖ
2. **Criar Perfil Individual** ‚úÖ
3. **Cadastrar TODOS os Usu√°rios** ‚úÖ
4. **Login de Usu√°rio** ‚úÖ
5. **Gerenciar Tokens** ‚úÖ

### üêõ Bugs Corrigidos

| Bug | Descri√ß√£o | Solu√ß√£o |
|-----|-----------|---------|
| `created_at` | AttributeError no objeto Session | Substitu√≠do por `datetime.now().isoformat()` |
| `profile_name` | Par√¢metro incorreto em fun√ß√µes batch | Adicionado par√¢metro opcional |
| Interatividade | Prompts bloqueando processamento batch | Criada vers√£o silenciosa |
| Importa√ß√£o | Fun√ß√£o `set_session` n√£o existente | Corrigido para `client.auth.set_session()` |

### üìÅ Estrutura de Arquivos Atualizada

```
tricket-backend/testing-tricket/
‚îú‚îÄ‚îÄ operations/
‚îÇ   ‚îú‚îÄ‚îÄ auth.py                    # Login e cria√ß√£o de contas
‚îÇ   ‚îú‚îÄ‚îÄ profile.py                 # Perfis organizacionais (interativo)
‚îÇ   ‚îú‚îÄ‚îÄ individual_profile.py      # Perfis individuais (NOVO)
‚îÇ   ‚îú‚îÄ‚îÄ profile_batch.py           # Perfis organizacionais (batch) (NOVO)
‚îÇ   ‚îú‚îÄ‚îÄ bulk_operations.py         # Cadastro em lote (atualizado)
‚îÇ   ‚îî‚îÄ‚îÄ token_manager.py           # Gerenciamento de tokens (NOVO)
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ session_manager.py         # Armazenamento de sess√µes
‚îÇ   ‚îî‚îÄ‚îÄ supabase_client.py         # Cliente Supabase
‚îú‚îÄ‚îÄ main.py                        # Interface principal
‚îî‚îÄ‚îÄ README.md                      # Documenta√ß√£o (atualizada)
```

### üöÄ Como Usar

#### Cadastro Individual
```bash
python3 main.py
# Escolher: 1. Criar Conta + Perfil Completo
```

#### Cadastro em Lote
```bash
python3 main.py
# Escolher: 3. Cadastrar TODOS os Usu√°rios
```

#### Login de Usu√°rio
```bash
python3 main.py
# Escolher: 4. Login de Usu√°rio
```

### üîê Seguran√ßa

- Tokens armazenados localmente em arquivo `.json` protegido
- Sess√µes gerenciadas automaticamente
- Credenciais n√£o logadas em produ√ß√£o

### ‚úÖ Pr√≥ximos Passos Recomendados

1. **Adicionar testes unit√°rios** para as novas fun√ß√µes
2. **Implementar logs estruturados** para auditoria
3. **Criar valida√ß√µes adicionais** de dados
4. **Documentar API** para integra√ß√£o com CI/CD

---

**Status:** ‚úÖ **SISTEMA TOTALMENTE FUNCIONAL**  
**Taxa de Sucesso:** 100% em todos os testes  
**Pronto para produ√ß√£o:** ‚úÖ
