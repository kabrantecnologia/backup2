# Changelog Consolidado — 2025-08-10 a 2025-08-11

Este documento consolida os seguintes arquivos do diretório `tricket-vault/changelog/`:

- 2025-08-11-1126-atualizacoes_sistema_testes.md
- 2025-08-11-1117-rpc_and_marketplace_inserts.md
- 2025-08-11-1038-atualizacao_documentacao_arquitetura.md
- 2025-08-10-1521-refatoracao-testes-tricket.md

---

## 2025-08-11T11:26:01-03:00 — Changelog — Sistema de Testes Tricket

Data/Hora: 2025-08-11T11:26:01-03:00

### Contexto
Alinhamento do sistema de testes em `tricket-backend/testing-tricket/` com as funcionalidades presentes no código, inclusão de operação de aprovação de profiles (Admin) e correções no README.

### Alterações Principais
- Atualização do `README.md` para refletir fielmente o menu de operações do `main.py`.
- Inclusão da operação interativa de aprovação: "Aprovar Profile (Admin)" no menu do sistema de testes.
- Criação de helper robusto para aprovação (`_approve_profile_by_id`) com fallback de RPCs: `rpc_approve_user_profile` e `approve_user_profile`.
- Padronização do script `approve_specific_profile.py` para remover ID hardcoded e aceitar ID via CLI ou modo interativo.
- Correção dos perfis de exemplo no README para: `admin`, `fornecedor`, `comerciante`, `consumidor`.
- Inclusão de instruções rápidas de instalação (venv + requirements) e remoção de dependência de índices numéricos do menu.

### Arquivos Modificados
- `tricket-backend/testing-tricket/README.md`
- `tricket-backend/testing-tricket/main.py`
- `tricket-backend/testing-tricket/operations/profile_approval.py`
- `tricket-backend/testing-tricket/approve_specific_profile.py`

### Detalhes Técnicos
- `main.py`: adicionado import e mapeamento da operação "Aprovar Profile (Admin)" para `approve_user_profile_interactive`.
- `operations/profile_approval.py`:
  - Novo helper `_approve_profile_by_id(project_name, profile_id)` com autenticação do admin e tentativa sequencial das RPCs.
  - Nova função `approve_user_profile_interactive(project_name)` que solicita o ID do profile.
  - `approve_user_profile` agora delega ao helper interno.
- `approve_specific_profile.py`:
  - Suporte a `profile_id` via argumento de linha de comando.
  - Caso não informado, ativa fluxo interativo reutilizando `approve_user_profile_interactive`.

### Instruções de Uso
1. Opcional: criar e ativar venv, instalar dependências em `tricket-backend/testing-tricket/`:
   ```bash
   python -m venv .venv && source .venv/bin/activate
   pip install -r requirements.txt
   ```
2. Executar o sistema de testes:
   ```bash
   python main.py
   ```
3. Para aprovar profiles:
   - Faça login como `admin@tricket.com.br` (operação "Login de Usuário").
   - Liste profiles pendentes ("Ver Profiles para Aprovação (Admin)").
   - Aprove com:
     - Pelo menu: "Aprovar Profile (Admin)" (insira o ID solicitado);
     - Ou via script:
       ```bash
       python approve_specific_profile.py <PROFILE_ID>
       # ou sem argumento para modo interativo
       python approve_specific_profile.py
       ```

### Impacto
- Documentação do sistema de testes coerente com o código atual.
- Fluxo de aprovação de profiles disponível via menu e script, reduzindo erros por nomes de RPC divergentes.
- Melhoria na DX com exemplos atualizados e instalação orientada.

---

## 2025-08-11T11:17:28-03:00 — RPC debug + Padrão RPC + Inserts Marketplace

### Resumo
- __[Novo]__ Função de diagnóstico `public.rpc_debug_request` para inspecionar como a requisição chega via Supabase (headers, claims, auth.uid, payload).
- __[Novo]__ Documento de padrão para desenvolvimento de RPCs.
- __[Novo]__ RPCs de criação (admin-only) para hierarquia do marketplace e catálogo base.

### Itens criados/alterados
- Arquivo: `tricket-backend/supabase/migrations/605_rpc_debug_request.sql`
  - Função: `public.rpc_debug_request(p_payload jsonb default '{}'::jsonb)`
  - Retorna: `JSONB` com `auth_uid`, `db_role`, `jwt_claims`, `headers`, `headers_summary`, `received_arguments`.
  - Segurança: `SECURITY DEFINER`, `SET search_path = ''`, `GRANT EXECUTE TO authenticated`.

- Arquivo: `tricket-vault/resources/rpc-functions-standard.md`
  - Guia oficial de padrões para criação de RPCs: segurança, naming, parâmetros, retornos, RBAC, exemplos (WeWeb, supabase-js, cURL), anti‑padrões e checklist.

- Arquivo: `tricket-backend/supabase/migrations/610_rpc_marketplace_insert.sql`
  - Helpers:
    - `public.slugify(text)`
    - `public._ensure_admin()` — valida ADMIN via `rbac_user_roles` + `rbac_roles`.
  - RPCs (ADMIN only):
    - `public.rpc_create_marketplace_department(p_data jsonb)`
    - `public.rpc_create_marketplace_category(p_data jsonb)`
    - `public.rpc_create_marketplace_sub_category(p_data jsonb)`
    - `public.rpc_create_marketplace_brand(p_data jsonb)`
    - `public.rpc_create_marketplace_product(p_data jsonb)`
  - Padrões: `SECURITY DEFINER`, `SET search_path = ''`, objetos qualificados, `GRANT EXECUTE TO authenticated`, retorno do registro inserido como `JSONB`, captura de `unique_violation`.

### Como chamar (WeWeb)
- Nó: Call a Postgres function
- Exemplo (create product): Function name `rpc_create_marketplace_product`
- Arguments:
```json
{
  "p_data": {
    "name": "Arroz Tipo 1 1kg",
    "gtin": "07894900086003",
    "brand_id": "<uuid>",
    "sub_category_id": "<uuid>",
    "attributes": { "tipo": "agulhinha" }
  }
}
```

### Observações de Segurança
- Apesar do `GRANT` para `authenticated`, as RPCs de inserção executam `public._ensure_admin()` e falham para não-admins.
- `rpc_debug_request` não altera estado; retorno inclui headers e claims para documentação e troubleshooting.

### Motivação
- Documentar e padronizar o consumo de RPCs pelo front-end WeWeb.
- Fornecer endpoints administráveis para popular a hierarquia do marketplace e catálogo.

### Impacto
- Front-end pode diagnosticar chamadas via `rpc_debug_request`.
- Admin pode cadastrar departamentos/categorias/subcategorias/marcas/produtos via RPC segura e padronizada.

### Próximos Passos Sugeridos
- Adicionar RPCs de atualização/remoção com as mesmas diretrizes.
- Testes automatizados SQL para validação de entradas e cenários de erro.
- Ajustar políticas RLS conforme necessidade.

---

## 2025-08-11 — Atualização da Documentação de Arquitetura e Dicionário de Dados

Data: 2025-08-11  
Responsável: Cascade (Assistente)

### Escopo
- Documentos afetados:
  - `tricket-vault/resources/110-supabase_arquitetura.md`
  - `tricket-vault/resources/120_dicionario_de_dados.md`
- Fonte de verdade analisada:
  - `tricket-backend/supabase/migrations/`

### Resumo das Alterações
- Arquitetura (`110-supabase_arquitetura.md`)
  - Ajuste dos nomes de arquivos de migração para o padrão atual (ex.: `100_global_settings.sql`, `120_rbac.sql`, `200_iam_tables.sql`, `140_ui_structure.sql`, etc.).
  - Inclusão das novas entidades do módulo “Asaas Master Webhook” de `231_asaas_master_webhook.sql`:
    - Tabelas: `public.master_webhook_events`, `public.master_financial_transactions`, `public.subscription_propagation_log`.
    - View: `public.v_master_webhook_summary`.
    - Triggers: `update_master_webhook_events_updated_at`, `update_master_financial_transactions_updated_at`, `update_subscription_propagation_log_updated_at`.
  - Correção e reorganização da seção de Views para refletir os arquivos: `300_views_global.sql`, `310_views_admin.sql`, `320_views_asaas.sql`, `330_cms_views.sql`.
  - Atualização do mapeamento de Funções para os arquivos corretos:
    - Core/Util: `100_global_settings.sql`, `530_functions_calculate_geolocation.sql`.
    - Checks: `500_functions_check.sql`.
    - Contexto: `510_functions_user_contexts.sql`.
    - IAM: `560_iam_functions.sql`.
    - Termos: `520_functions_terms.sql`.
    - Registro de perfis: `550_functions_register_profiles.sql`.
    - Marketplace/Produtos: `540_functions_check_product_exists.sql`.
    - Asaas: `570_functions_asaas.sql`.
    - Cappta: `580_functions_cappta.sql`.
    - Asaas Master: `231_asaas_master_webhook.sql` (função `update_updated_at_column`).
  - Atualização das referências de índices e FKs conforme migrações vigentes, incluindo índices de Asaas Master.
  - Ajuste das fontes dos GRANTs para as novas migrações de funções.

- Dicionário de Dados (`120_dicionario_de_dados.md`)
  - Completação da tabela `public.gs1_api_responses` a partir de `220_gs1_tables.sql` com colunas, constraints e comentários.
  - Inclusão da view `v_master_webhook_summary` na listagem de views.

### Itens Não Modificados
- Sem alterações nos arquivos SQL de migração; somente documentação atualizada.

### Observações / Pontos de Atenção
- RLS/Policies: manter rastreamento contínuo; apenas exemplos presentes foram listados. Uma varredura adicional pode ser necessária ao evoluir o esquema.
- Algumas seções do dicionário ainda têm [TODO] (ex.: opções Cappta) e podem ser preenchidas em iterações seguintes.

### Referências
- `tricket-backend/supabase/migrations/100_global_settings.sql`
- `tricket-backend/supabase/migrations/120_rbac.sql`
- `tricket-backend/supabase/migrations/130_cms_blog_structure.sql`
- `tricket-backend/supabase/migrations/140_ui_structure.sql`
- `tricket-backend/supabase/migrations/200_iam_tables.sql`
- `tricket-backend/supabase/migrations/210_marketplace_tables.sql`
- `tricket-backend/supabase/migrations/220_gs1_tables.sql`
- `tricket-backend/supabase/migrations/231_asaas_master_webhook.sql`
- `tricket-backend/supabase/migrations/300_views_global.sql`
- `tricket-backend/supabase/migrations/310_views_admin.sql`
- `tricket-backend/supabase/migrations/320_views_asaas.sql`
- `tricket-backend/supabase/migrations/330_cms_views.sql`
- `tricket-backend/supabase/migrations/500_functions_check.sql`
- `tricket-backend/supabase/migrations/510_functions_user_contexts.sql`
- `tricket-backend/supabase/migrations/520_functions_terms.sql`
- `tricket-backend/supabase/migrations/530_functions_calculate_geolocation.sql`
- `tricket-backend/supabase/migrations/540_functions_check_product_exists.sql`
- `tricket-backend/supabase/migrations/550_functions_register_profiles.sql`
- `tricket-backend/supabase/migrations/560_iam_functions.sql`
- `tricket-backend/supabase/migrations/570_functions_asaas.sql`
- `tricket-backend/supabase/migrations/580_functions_cappta.sql`

---

## 2025-08-10 15:21:33 (UTC-3) — 🚀 Refatoração Completa - Sistema de Testes Tricket

**Data:** 2025-08-10 15:21:33 (UTC-3)  
**Autor:** SHELDON  
**Branch:** sprint-8  
**Status:** ✅ COMPLETO

### 📋 Resumo das Mudanças

Sistema de testes automatizados do Tricket backend completamente refatorado com correção de bugs críticos e implementação de detecção automática de tipos de perfil.

### 🎯 Objetivo Principal

- **Corrigir** erro de atributo `created_at` no objeto Session
- **Implementar** detecção automática entre perfis individuais e organizacionais
- **Garantir** 100% de taxa de sucesso no cadastro em lote

### 🔧 Arquivos Modificados

#### `operations/auth.py`
- ✅ Corrigido erro `created_at` nas funções `create_user_and_profile()` e `login_user()`
- ✅ Adicionado uso de `datetime.now().isoformat()` para timestamps
- ✅ Implementada detecção automática de tipo de perfil

#### `operations/bulk_operations.py`
- ✅ Corrigido erro `created_at` no armazenamento de tokens
- ✅ Atualizada lógica para usar funções corretas baseadas no tipo de perfil
- ✅ Adicionada versão silenciosa para processamento em lote

#### `operations/individual_profile.py` (NOVO)
- ✅ Criada função `register_individual_profile_from_config()`
- ✅ Implementada lógica específica para perfis individuais (CONSUMER)
- ✅ Interface interativa para seleção de perfis

#### `operations/profile_batch.py` (NOVO)
- ✅ Criada versão silenciosa `register_organization_profile_batch()`
- ✅ Otimizada para processamento em lote sem interação
- ✅ Tratamento de erros simplificado para operações automatizadas

#### `operations/token_manager.py` (NOVO)
- ✅ Sistema completo de gerenciamento de tokens
- ✅ Armazenamento local seguro de sessões
- ✅ Interface CLI para gerenciar tokens ativos

#### `main.py`
- ✅ Adicionada opção "Criar Perfil Individual" no menu principal
- ✅ Integração com todas as novas funcionalidades
- ✅ Menu interativo aprimorado

#### `operations/profile.py`
- ✅ Atualizada `register_organization_profile_from_config()` para aceitar parâmetro opcional
- ✅ Adicionada lógica para uso direto de `profile_name` em modo batch

#### `README.md` (ATUALIZADO)
- ✅ Documentação completa das novas operações
- ✅ Instruções de uso para cada funcionalidade
- ✅ Exemplos de configuração

### 🧪 Testes Realizados

#### ✅ Cadastro em Lote
```
Total Processado: 4
✅ Sucessos: 4
❌ Falhas: 0
📊 Taxa de Sucesso: 100.0%
```

#### ✅ Tipos de Perfil Detectados Automaticamente
- **CONSUMER** → `register_individual_profile_from_config()`
- **FORNECEDOR/COMERCIANTE/REVENDEDOR** → `register_organization_profile_batch()`

#### ✅ Operações Verificadas
1. **Criar Conta + Perfil Completo** ✅
2. **Criar Perfil Individual** ✅
3. **Cadastrar TODOS os Usuários** ✅
4. **Login de Usuário** ✅
5. **Gerenciar Tokens** ✅

### 🐛 Bugs Corrigidos

| Bug | Descrição | Solução |
|-----|-----------|---------|
| `created_at` | AttributeError no objeto Session | Substituído por `datetime.now().isoformat()` |
| `profile_name` | Parâmetro incorreto em funções batch | Adicionado parâmetro opcional |
| Interatividade | Prompts bloqueando processamento batch | Criada versão silenciosa |
| Importação | Função `set_session` não existente | Corrigido para `client.auth.set_session()` |

### 📁 Estrutura de Arquivos Atualizada

```
tricket-backend/testing-tricket/
├── operations/
│   ├── auth.py                    # Login e criação de contas
│   ├── profile.py                 # Perfis organizacionais (interativo)
│   ├── individual_profile.py      # Perfis individuais (NOVO)
│   ├── profile_batch.py           # Perfis organizacionais (batch) (NOVO)
│   ├── bulk_operations.py         # Cadastro em lote (atualizado)
│   └── token_manager.py           # Gerenciamento de tokens (NOVO)
├── core/
│   ├── session_manager.py         # Armazenamento de sessões
│   └── supabase_client.py         # Cliente Supabase
├── main.py                        # Interface principal
└── README.md                      # Documentação (atualizada)
```

### 🚀 Como Usar

#### Cadastro Individual
```bash
python3 main.py
# Escolher: 1. Criar Conta + Perfil Completo
```

#### Cadastro em Lote
```bash
python3 main.py
# Escolher: 3. Cadastrar TODOS os Usuários
```

#### Login de Usuário
```bash
python3 main.py
# Escolher: 4. Login de Usuário
```

### 🔐 Segurança

- Tokens armazenados localmente em arquivo `.json` protegido
- Sessões gerenciadas automaticamente
- Credenciais não logadas em produção

### ✅ Próximos Passos Recomendados

1. **Adicionar testes unitários** para as novas funções
2. **Implementar logs estruturados** para auditoria
3. **Criar validações adicionais** de dados
4. **Documentar API** para integração com CI/CD

---

**Status:** ✅ **SISTEMA TOTALMENTE FUNCIONAL**  
**Taxa de Sucesso:** 100% em todos os testes  
**Pronto para produção:** ✅
